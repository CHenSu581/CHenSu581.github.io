<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¨ç½‘è·å®¢é›·è¾¾ Ultimate ğŸ“¡</title>
    <style>
        :root {
            --primary-color: #007AFF;
            --danger-color: #FF3B30;
            --text-main: #1D1D1F;
            --text-secondary: #86868B;
            --glass-bg: rgba(255, 255, 255, 0.65);
            --glass-border: rgba(255, 255, 255, 0.8);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "PingFang SC", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 40px 20px;
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(0, 122, 255, 0.1), transparent 60%), radial-gradient(circle at 80% 20%, rgba(255, 59, 48, 0.1), transparent 50%);
            z-index: -1;
            animation: bgMove 20s ease-in-out infinite alternate;
        }

        @keyframes bgMove {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-5%, -5%);
            }
        }

        .container {
            max-width: 860px;
            width: 100%;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            margin: 0;
            font-size: 32px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            color: #1d1d1f;
        }

        .badge {
            font-size: 13px;
            background: linear-gradient(135deg, #333, #555);
            color: #fff;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 600;
        }

        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--glass-shadow);
        }

        .control-panel {
            padding: 30px;
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            font-size: 15px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-main);
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-col {
            flex: 1;
        }

        input[type="text"],
        input[type="number"],
        select {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.5);
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 14px;
            font-size: 16px;
            outline: none;
            box-sizing: border-box;
            transition: all 0.2s ease;
        }

        input:focus,
        select:focus {
            background: #fff;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.15);
        }

        .hint {
            font-size: 13px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .segmented-control {
            display: flex;
            background: rgba(118, 118, 128, 0.12);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .segmented-control input[type="radio"] {
            display: none;
        }

        .segmented-control label {
            flex: 1;
            text-align: center;
            padding: 10px 0;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 9px;
            transition: all 0.2s ease;
            margin: 0;
        }

        .segmented-control input[type="radio"]:checked+label {
            background: #fff;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            font-weight: 600;
        }

        .custom-days-wrapper {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        button#btn {
            width: 100%;
            background: linear-gradient(135deg, #007AFF, #0056b3);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        button#btn:hover {
            transform: scale(1.01);
        }

        button#btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .query-preview {
            background: rgba(255, 255, 255, 0.4);
            padding: 16px;
            border-radius: 12px;
            font-size: 14px;
            margin-bottom: 24px;
            border: 1px dashed rgba(0, 0, 0, 0.1);
            display: flex;
            gap: 8px;
        }

        .result-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .lead-card {
            padding: 24px;
            transition: all 0.3s;
            position: relative;
        }

        .lead-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
            background: var(--primary-color);
        }

        .lead-card:hover {
            transform: translateY(-4px);
        }

        .lead-title {
            font-size: 19px;
            font-weight: 700;
            color: var(--text-main);
            text-decoration: none;
            display: block;
            margin-bottom: 12px;
        }

        .lead-title:hover {
            color: var(--primary-color);
        }

        .tags-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .time-tag {
            background: rgba(0, 122, 255, 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
        }

        .lead-body {
            font-size: 15px;
            color: #444;
            line-height: 1.6;
            background: rgba(255, 255, 255, 0.5);
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 14px;
        }

        .lead-footer {
            padding-top: 14px;
            border-top: 1px solid rgba(0, 0, 0, 0.06);
            font-size: 14px;
            color: var(--danger-color);
            font-weight: 600;
        }

        #status {
            text-align: center;
            margin: 20px 0;
            color: var(--text-secondary);
            font-weight: 500;
        }

        @keyframes spin {
            from {
                transform: rotate(0deg);
            }

            to {
                transform: rotate(360deg);
            }
        }

        .spin {
            display: inline-block;
            animation: spin 1s linear infinite;
        }

        .error-panel {
            background: linear-gradient(135deg, rgba(255, 59, 48, 0.1), rgba(255, 149, 0, 0.1));
            border: 2px solid rgba(255, 59, 48, 0.3);
            padding: 20px;
            border-radius: 16px;
            text-align: center;
            margin: 20px 0;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .error-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--danger-color);
            margin-bottom: 8px;
        }

        input.invalid {
            border-color: var(--danger-color) !important;
            box-shadow: 0 0 0 4px rgba(255, 59, 48, 0.15) !important;
        }

        @media screen and (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 0;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“¡ å…¨ç½‘è·å®¢é›·è¾¾ <span class="badge">Ultimate</span></h1>
        </div>

        <div class="control-panel glass-panel">
            <div class="form-group">
                <label>ğŸ” æ ¸å¿ƒä¸šåŠ¡å…³é”®è¯</label>
                <input type="text" id="coreKeyword" value="" oninput="updatePreview()"
                    placeholder="ä¾‹å¦‚: è£…ä¿®è®¾è®¡ / å¾‹å¸ˆå’¨è¯¢ / äºŒæ‰‹è½¦ / å¥èº«æ•™ç»ƒ">
            </div>

            <div class="form-row">
                <div class="form-col">
                    <label>ğŸ¯ é”å®šç›®æ ‡å¹³å°</label>
                    <select id="targetPlatform" onchange="updatePreview()">
                        <option value="all">ğŸŒ å…¨ç½‘æœç´¢</option>
                        <option value="xiaohongshu">ğŸ“• å°çº¢ä¹¦</option>
                        <option value="bilibili">ğŸ“º Bilibili</option>
                        <option value="douyin">ğŸµ æŠ–éŸ³</option>
                        <option value="zhihu">â“ çŸ¥ä¹</option>
                    </select>
                </div>
                <div class="form-col">
                    <label>âš™ï¸ åº•å±‚æœç´¢å¼•æ“</label>
                    <select id="searchEngine">
                        <option value="google" selected>è°·æ­Œ (Google)</option>
                        <option value="baidu">ç™¾åº¦ (Baidu)</option>
                    </select>
                </div>
            </div>

            <div class="form-row" style="margin-top: 24px;">
                <div class="form-col">
                    <label>ğŸ¯ æ„å‘ç‰¹å¾ (ç©ºæ ¼åˆ†éš”)</label>
                    <input type="text" id="intentKeywords" value="" oninput="updatePreview()"
                        placeholder="ä¾‹å¦‚: ä»·æ ¼ è´¹ç”¨ æ±‚æ¨è æ€ä¹ˆé€‰">
                    <div class="hint">åŒ…å«ä»»ä¸€è¯å³å‘½ä¸­ (è¡¨ç¤ºè´­ä¹°æ„å‘çš„è¯)</div>
                </div>
                <div class="form-col">
                    <label>ğŸš« æ’é™¤å¹²æ‰° (ç©ºæ ¼åˆ†éš”)</label>
                    <input type="text" id="negativeKeywords" value="æ‹›è˜ æ‹›äºº æ±‚èŒ å²—ä½" oninput="updatePreview()"
                        placeholder="ä¾‹å¦‚: æ‹›è˜ å¹¿å‘Š å…è´¹">
                    <div class="hint">åŒ…å«ä»»ä¸€è¯å³è¿‡æ»¤ (æ’é™¤å–æ–¹/æ‹›è˜ä¿¡æ¯)</div>
                </div>
            </div>

            <div class="form-group" style="margin-top: 24px;">
                <label>â° å‘å¸ƒæ—¶é—´èŒƒå›´</label>
                <div class="segmented-control">
                    <input type="radio" name="timeRange" id="time1" value="1" onchange="handleTimeChange(this)">
                    <label for="time1">24å°æ—¶</label>
                    <input type="radio" name="timeRange" id="time3" value="3" onchange="handleTimeChange(this)">
                    <label for="time3">3å¤©</label>
                    <input type="radio" name="timeRange" id="time7" value="7" checked onchange="handleTimeChange(this)">
                    <label for="time7">7å¤©</label>
                    <input type="radio" name="timeRange" id="time30" value="30" onchange="handleTimeChange(this)">
                    <label for="time30">30å¤©</label>
                    <input type="radio" name="timeRange" id="timeCustom" value="custom"
                        onchange="handleTimeChange(this)">
                    <label for="timeCustom">è‡ªå®šä¹‰</label>
                </div>
                <div class="custom-days-wrapper" id="customDaysWrapper">
                    <span>è¿‡å»</span>
                    <input type="number" id="customDaysInput" value="15" min="1" max="365"
                        style="width: 80px; text-align: center;" oninput="validateAndUpdate()">
                    <span>å¤©</span>
                </div>
            </div>

            <div class="form-group" style="margin-top: 24px;">
                <div class="form-col">
                    <label>ğŸ“Š æŠ“å–æ•°é‡ (å½±å“é€Ÿåº¦)</label>
                    <select id="resultLimit">
                        <option value="10">âš¡ 10 æ¡ (æé€Ÿ)</option>
                        <option value="20">ğŸš€ 20 æ¡ (æ¨è)</option>
                        <option value="50">â˜• 50 æ¡ (ç¨æ…¢)</option>
                        <option value="100">ğŸ¢ 100 æ¡ (æ…ç”¨)</option>
                    </select>
                </div>
            </div>

            <div class="query-preview">
                <span>ğŸ¤–</span>
                <div>
                    <strong>AI æŒ‡ä»¤é¢„è§ˆ:</strong>
                    <span id="previewText"></span>
                </div>
            </div>

            <button onclick="startRadar()" id="btn">ğŸš€ å¯åŠ¨å…¨ç½‘æ‰«æ</button>
        </div>

        <div id="status">ç³»ç»Ÿå°±ç»ª,è¯·é…ç½®å‚æ•°åå¯åŠ¨...</div>
        <div id="results" class="result-list"></div>
    </div>

    <script>
        const N8N_API_URL = 'http://192.168.1.250:5678/webhook/search-leads';

        function handleTimeChange(radio) {
            const wrapper = document.getElementById('customDaysWrapper');
            wrapper.style.display = radio.value === 'custom' ? 'flex' : 'none';
            if (radio.value === 'custom') document.getElementById('customDaysInput').focus();
            updatePreview();
        }

        function validateAndUpdate() {
            const input = document.getElementById('customDaysInput');
            let value = parseInt(input.value);
            if (isNaN(value) || value < 1) value = 1;
            if (value > 365) value = 365;
            input.value = value;
            updatePreview();
        }

        function getSelectedDays() {
            const radios = document.getElementsByName('timeRange');
            for (const radio of radios) {
                if (radio.checked) {
                    if (radio.value === 'custom') {
                        return parseInt(document.getElementById('customDaysInput').value) || 7;
                    }
                    return parseInt(radio.value);
                }
            }
            return 7;
        }

        function generateQuery() {
            const core = document.getElementById('coreKeyword').value.trim();
            const intents = document.getElementById('intentKeywords').value.trim();
            const negatives = document.getElementById('negativeKeywords').value.trim();
            const platform = document.getElementById('targetPlatform').value;

            if (!core) return "";

            let query = core;

            const siteMap = {
                'xiaohongshu': 'site:xiaohongshu.com',
                'bilibili': 'site:bilibili.com',
                'douyin': 'site:douyin.com',
                'zhihu': 'site:zhihu.com'
            };

            if (siteMap[platform]) query += ` ${siteMap[platform]}`;
            if (intents) {
                const intentList = intents.split(/\s+/).map(w => `"${w}"`).join(" | ");
                query += ` (${intentList})`;
            }
            if (negatives) {
                const negList = negatives.split(/\s+/).map(w => `-${w}`).join(" ");
                query += ` ${negList}`;
            }

            return query;
        }

        function updatePreview() {
            const query = generateQuery();
            const days = getSelectedDays();
            const engine = document.getElementById('searchEngine').value;
            const previewHtml = query
                ? `${query} <span style="color:var(--primary-color); margin-left:8px; font-weight:600;">[${engine.toUpperCase()} / ${days}å¤©]</span>`
                : "è¯·è¾“å…¥æ ¸å¿ƒå…³é”®è¯...";
            document.getElementById('previewText').innerHTML = previewHtml;
        }

        updatePreview();

        async function startRadar() {
            const coreInput = document.getElementById('coreKeyword');
            const query = generateQuery();
            const days = getSelectedDays();
            const btn = document.getElementById('btn');
            const status = document.getElementById('status');
            const resultBox = document.getElementById('results');

            if (!query) {
                coreInput.classList.add('invalid');
                alert("è¯·è¾“å…¥æ ¸å¿ƒå…³é”®è¯!");
                coreInput.focus();
                return;
            }
            coreInput.classList.remove('invalid');

            btn.disabled = true;
            btn.innerHTML = '<span class="spin">â³</span> æ­£åœ¨å…¨ç½‘æ‰«æä¸­...';

            try {
                // 1. è·å–ç•Œé¢å‚æ•°
                const engine = document.getElementById('searchEngine').value;
                const limitSelect = document.getElementById('resultLimit');
                const limit = limitSelect ? limitSelect.value : 10;

                status.innerHTML = `æ­£åœ¨è°ƒç”¨ <b>${engine.toUpperCase()}</b> æ‰§è¡ŒæŒ‡ä»¤:<br><b>${query}</b>`;
                resultBox.innerHTML = "";

                // 2. å‘é€è¯·æ±‚
                const requestBody = {
                    keyword: query,
                    days: days,
                    engine: engine,
                    limit: parseInt(limit)
                };
                console.log('ğŸš€ å‘é€è¯·æ±‚:', requestBody);

                const response = await fetch(N8N_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const json = await response.json();
                console.log('ğŸ“¦ n8n åŸå§‹å“åº”:', json);

                let leads = [];
                if (json.code === 200 && json.data && Array.isArray(json.data)) {
                    leads = json.data;
                    console.log(`âœ… æˆåŠŸè§£æ n8n æ•°æ®: ${json.total} æ¡`);
                } else if (Array.isArray(json)) {
                    leads = json;
                } else if (json.data && Array.isArray(json.data)) {
                    leads = json.data;
                }

                console.log(`ğŸ“Š è§£æåçš„æ•°æ®æ€»æ•°: ${leads.length} æ¡`);
                console.log('ğŸ“‹ æ•°æ®è¯¦æƒ…:', leads);

                const highIntentLeads = leads.filter(lead => {
                    const level = lead.intent_level || lead.is_lead;
                    return level === 'High' || level === 'Medium' || level === 'YES';
                });

                console.log(`ğŸ¯ æœ‰æ•ˆçº¿ç´¢æ•°: ${highIntentLeads.length} æ¡ (High/Medium)`);
                console.log(`ğŸ—‘ï¸ å·²è¿‡æ»¤: ${leads.length - highIntentLeads.length} æ¡ (Low)`);

                if (highIntentLeads.length === 0) {
                    resultBox.innerHTML = `
                        <div class="glass-panel" style="text-align:center; padding:40px; color:var(--text-secondary);">
                            <div style="font-size:40px; margin-bottom:10px;">ğŸ˜•</div>
                            <div>æœ¬æ¬¡æœªå‘ç°é«˜æ„å‘çº¿ç´¢</div>
                            <div style="font-size:12px; margin-top:5px;">AI å·²ä» ${leads.length} æ¡ç»“æœä¸­è¿‡æ»¤æ‰å…¨éƒ¨ä½è´¨é‡å†…å®¹(Low)</div>
                        </div>`;
                    status.innerText = "âœ… æ‰«æå®Œæˆ (æ— é«˜æ„å‘ç»“æœ)";
                } else {
                    status.innerText = `âœ… æ‰«æå®Œæˆ!ä» ${leads.length} æ¡ä¸­å‘ç° ${highIntentLeads.length} æ¡æœ‰æ•ˆçº¿ç´¢`;

                    highIntentLeads.forEach(lead => {
                        const safeTitle = lead.title || 'æ— æ ‡é¢˜ä¿¡æ¯';
                        const safeSnippet = lead.snippet || 'æš‚æ— æ‘˜è¦';
                        const safePain = lead.pain_point || 'æ— ';

                        let tagHtml = '';
                        const level = lead.intent_level || lead.is_lead;
                        if (level === 'High' || level === 'YES') {
                            tagHtml = '<span class="tag" style="background:#ffecec; color:#ff2442;">ğŸ”¥ é«˜æ„å‘</span>';
                        } else if (level === 'Medium') {
                            tagHtml = '<span class="tag" style="background:#e3f2fd; color:#1976d2;">ğŸ¤” æ½œåœ¨</span>';
                        }

                        const card = `
                            <div class="lead-card glass-panel">
                                <a href="${lead.link}" target="_blank" rel="noopener noreferrer" class="lead-title">${safeTitle}</a>
                                <div class="tags-row">
                                    ${tagHtml}
                                    <span class="time-tag">${days}å¤©å†…å‘å¸ƒ</span>
                                </div>
                                <div class="lead-body">${safeSnippet}</div>
                                <div class="lead-footer">ğŸ¯ AI æ´å¯Ÿ:${safePain}</div>
                            </div>
                        `;
                        resultBox.innerHTML += card;
                    });
                }

            } catch (error) {
                console.error('æ‰«æé”™è¯¯:', error);
                status.innerHTML = `<span style="color:var(--danger-color)">âŒ æ‰«æå¤±è´¥</span>`;
                resultBox.innerHTML = `
                    <div class="error-panel">
                        <div class="error-icon">âš ï¸</div>
                        <div class="error-title">è¿æ¥é”™è¯¯</div>
                        <div style="font-size: 14px; color: var(--text-secondary);">
                            ${error.message}<br>
                            <small>è¯·æ£€æŸ¥ n8n æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ (${N8N_API_URL})</small>
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerText = "ğŸš€ å¯åŠ¨å…¨ç½‘æ‰«æ";
            }
        }
    </script>
</body>

</html>